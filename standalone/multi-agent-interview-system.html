<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Multi-Agente - Gemelos Digitales</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            font-size: 13px;
        }
        
        .header {
            background-color: white;
            padding: 12px 15px;
            border-bottom: 1px solid #ddd;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .header h1 {
            font-size: 18px;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .header p {
            color: #7f8c8d;
            font-size: 12px;
        }
        
        /* Agent Selection Bar */
        .agent-bar {
            background-color: #34495e;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            overflow-x: auto;
            border-bottom: 2px solid #2c3e50;
        }
        
        .agent-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }
        
        .agent-selector label {
            color: #ecf0f1;
            font-size: 12px;
            font-weight: 500;
        }
        
        .agent-selector select {
            padding: 6px 10px;
            border-radius: 4px;
            border: none;
            background-color: #ecf0f1;
            color: #2c3e50;
            font-size: 12px;
            cursor: pointer;
            min-width: 150px;
        }
        
        .agent-info {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background-color: #2c3e50;
            border-radius: 20px;
            color: #ecf0f1;
            font-size: 11px;
        }
        
        .agent-info-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .agent-info-item span {
            opacity: 0.8;
        }
        
        .agent-actions {
            margin-left: auto;
            display: flex;
            gap: 8px;
        }
        
        .agent-actions button {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-load-agents {
            background-color: #3498db;
            color: white;
        }
        
        .btn-load-agents:hover {
            background-color: #2980b9;
        }
        
        .btn-compare {
            background-color: #9b59b6;
            color: white;
        }
        
        .btn-compare:hover {
            background-color: #8e44ad;
        }
        
        /* Main Layout Container */
        .main-container {
            flex: 1;
            display: flex;
            gap: 10px;
            padding: 10px;
            overflow: hidden;
            height: calc(100vh - 120px);
        }
        
        /* Left column for analysis and survey */
        .left-panels {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 50%;
            min-height: 0;
        }
        
        /* Right column for chat and experiment */
        .right-panels {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 50%;
            min-height: 0;
        }
        
        /* Panel Styles - Common */
        .panel {
            background-color: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }
        
        /* All panels equal size - 50% height in their respective columns */
        .panel.dashboard,
        .panel.survey-panel,
        .chat-wrapper,
        .panel.experiment-panel {
            width: 100%;
            height: calc(50% - 5px);
            min-height: 200px;
        }
        
        /* Agent Profile Card */
        .agent-profile-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 12px;
        }
        
        .agent-profile-card h3 {
            font-size: 16px;
            margin-bottom: 8px;
        }
        
        .agent-profile-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            font-size: 11px;
        }
        
        .agent-profile-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .agent-profile-item strong {
            opacity: 0.9;
        }
        
        /* Comparison Mode */
        .comparison-mode {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 1000;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            display: none;
        }
        
        .comparison-mode.active {
            display: block;
        }
        
        .comparison-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .comparison-agent {
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 6px;
        }
        
        .comparison-agent h4 {
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 13px;
        }
        
        .comparison-response {
            font-size: 11px;
            color: #555;
            line-height: 1.4;
            padding: 8px;
            background-color: #f8f9fa;
            border-radius: 4px;
            margin-top: 5px;
        }
        
        /* File Upload Area */
        .file-upload-area {
            border: 2px dashed #3498db;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background-color: #ecf7fd;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-upload-area:hover {
            background-color: #d6effd;
            border-color: #2980b9;
        }
        
        .file-upload-area.dragover {
            background-color: #bde4f7;
            border-color: #2980b9;
        }
        
        .file-upload-area p {
            color: #2c3e50;
            margin-bottom: 8px;
        }
        
        .file-upload-area small {
            color: #7f8c8d;
            font-size: 10px;
        }
        
        /* Panel header styles */
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        /* Dashboard Tabs */
        .dashboard-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 12px;
            border-bottom: 1px solid #ddd;
        }
        
        .tab {
            padding: 6px 12px;
            background: none;
            border: none;
            color: #7f8c8d;
            cursor: pointer;
            font-size: 12px;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .tab:hover {
            color: #34495e;
        }
        
        .tab.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }
        
        .dashboard-content {
            display: none;
        }
        
        .dashboard-content.active {
            display: block;
        }
        
        /* Chat styles */
        .chat-wrapper {
            display: flex;
            flex-direction: column;
        }
        
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: white;
            overflow: hidden;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .message {
            max-width: 70%;
            padding: 8px 12px;
            border-radius: 16px;
            word-wrap: break-word;
            line-height: 1.3;
            font-size: 13px;
        }
        
        .message.user {
            align-self: flex-end;
            background-color: #3498db;
            color: white;
        }
        
        .message.assistant {
            align-self: flex-start;
            background-color: #ecf0f1;
            color: #2c3e50;
        }
        
        .input-container {
            padding: 10px;
            border-top: 1px solid #ddd;
            display: flex;
            gap: 8px;
            background-color: white;
        }
        
        .input-container input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 13px;
            outline: none;
        }
        
        .input-container input:focus {
            border-color: #3498db;
        }
        
        .input-container button {
            padding: 8px 16px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .input-container button:hover {
            background-color: #2980b9;
        }
        
        .input-container button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        
        .loading {
            display: none;
            align-self: flex-start;
            padding: 6px 12px;
            color: #7f8c8d;
            font-style: italic;
            font-size: 12px;
        }
        
        .loading.show {
            display: block;
        }
        
        /* API Key Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .overlay.hidden {
            display: none;
        }
        
        .api-key-modal {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            max-width: 450px;
            width: 90%;
        }
        
        .api-key-modal h2 {
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 18px;
        }
        
        .api-key-modal input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            margin-bottom: 8px;
        }
        
        .api-key-modal button {
            width: 100%;
            padding: 8px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
        }
        
        /* Hidden file input */
        #agentFileInput {
            display: none;
        }
        
        /* Agent stats */
        .agent-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .stat-card {
            background: white;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stat-card .value {
            font-size: 20px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .stat-card .label {
            font-size: 10px;
            color: #7f8c8d;
            text-transform: uppercase;
            margin-top: 4px;
        }
        
        /* Modal Background Overlay */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        
        .modal-overlay.active {
            display: block;
        }
    </style>
</head>
<body>
    <!-- API Key Overlay -->
    <div class="overlay" id="apiKeyOverlay">
        <div class="api-key-modal">
            <h2>Configurar OpenAI API Key</h2>
            <p>Para continuar con el sistema multi-agente, necesitas proporcionar tu clave API de OpenAI.</p>
            <input 
                type="password" 
                id="apiKeyInput" 
                placeholder="sk-..."
                autocomplete="off"
            />
            <div class="error" id="apiKeyError" style="color: #e74c3c; font-size: 12px; margin-bottom: 8px; display: none;">Por favor, ingresa una API key v√°lida</div>
            <button onclick="saveApiKey()">Guardar y Continuar</button>
            <div style="margin-top: 12px; padding: 8px; background-color: #ecf0f1; border-radius: 4px; font-size: 11px; color: #7f8c8d; line-height: 1.3;">
                <strong>Nota:</strong> Tu API key se almacena solo en este navegador y se usa √∫nicamente para comunicarse con OpenAI.
                <br><br>
                ¬øNo tienes una API key? <a href="https://platform.openai.com/api-keys" target="_blank">Obt√©n una aqu√≠</a>
            </div>
        </div>
    </div>
    
    <div class="header">
        <h1>Sistema Multi-Agente de Entrevistas Digitales</h1>
        <p>Herramienta de investigaci√≥n: An√°lisis cualitativo con m√∫ltiples gemelos digitales</p>
        <button onclick="changeApiKey()" style="position: absolute; top: 10px; right: 15px; padding: 5px 10px; background-color: #ecf0f1; border: none; border-radius: 4px; cursor: pointer; font-size: 10px;">Cambiar API Key</button>
    </div>
    
    <!-- Agent Selection Bar -->
    <div class="agent-bar">
        <div class="agent-selector">
            <label>Agente Activo:</label>
            <select id="agentSelector" onchange="switchAgent()">
                <option value="">-- Selecciona un agente --</option>
            </select>
        </div>
        
        <div class="agent-info" id="agentInfo" style="display: none;">
            <div class="agent-info-item">
                <span>üë§</span>
                <strong id="agentName">-</strong>
            </div>
            <div class="agent-info-item">
                <span>üìç</span>
                <span id="agentLocation">-</span>
            </div>
            <div class="agent-info-item">
                <span>üí¨</span>
                <span id="agentInterviews">0 intercambios</span>
            </div>
        </div>
        
        <div class="agent-actions">
            <button class="btn-load-agents" onclick="document.getElementById('agentFileInput').click()">
                üìÅ Cargar Agentes (JSON)
            </button>
            <button class="btn-compare" onclick="openComparisonMode()">
                üîÑ Comparar Respuestas
            </button>
        </div>
    </div>
    
    <!-- Hidden file input -->
    <input type="file" id="agentFileInput" accept=".json" multiple onchange="loadAgentsFromFile(event)">
    
    <!-- Main Container -->
    <div class="main-container" id="mainContainer">
        <!-- Left Column -->
        <div class="left-panels">
            <!-- Analysis Panel -->
            <div class="panel dashboard" id="analysisPanel">
                <div class="panel-header">
                    <h2 style="margin: 0; color: #2c3e50; font-size: 13px;">üìä An√°lisis del Agente</h2>
                </div>
                <div style="flex: 1; overflow-y: auto;">
                    <!-- Agent Profile Card -->
                    <div class="agent-profile-card" id="agentProfileCard" style="display: none;">
                        <h3 id="profileName">-</h3>
                        <div class="agent-profile-grid">
                            <div class="agent-profile-item">
                                <strong>Edad:</strong>
                                <span id="profileAge">-</span>
                            </div>
                            <div class="agent-profile-item">
                                <strong>G√©nero:</strong>
                                <span id="profileGender">-</span>
                            </div>
                            <div class="agent-profile-item">
                                <strong>Ocupaci√≥n:</strong>
                                <span id="profileOccupation">-</span>
                            </div>
                            <div class="agent-profile-item">
                                <strong>Comuna:</strong>
                                <span id="profileLocation">-</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="dashboard-tabs">
                        <button class="tab active" onclick="switchTab('overview')">Resumen</button>
                        <button class="tab" onclick="switchTab('themes')">Temas</button>
                        <button class="tab" onclick="switchTab('stats')">Estad√≠sticas</button>
                    </div>
                    
                    <!-- Overview Tab -->
                    <div id="overview" class="dashboard-content active">
                        <div id="agentOverview" style="padding: 20px; text-align: center; color: #7f8c8d;">
                            <p>No hay agente seleccionado</p>
                            <p style="margin-top: 10px; font-size: 11px;">Carga un archivo JSON con agentes o selecciona uno de la lista</p>
                        </div>
                    </div>
                    
                    <!-- Themes Tab -->
                    <div id="themes" class="dashboard-content">
                        <div id="agentThemes" style="padding: 20px; text-align: center; color: #7f8c8d;">
                            <p>Los temas aparecer√°n aqu√≠ cuando selecciones un agente</p>
                        </div>
                    </div>
                    
                    <!-- Stats Tab -->
                    <div id="stats" class="dashboard-content">
                        <div class="agent-stats" id="agentStats">
                            <div class="stat-card">
                                <div class="value">-</div>
                                <div class="label">Mensajes</div>
                            </div>
                            <div class="stat-card">
                                <div class="value">-</div>
                                <div class="label">Palabras</div>
                            </div>
                            <div class="stat-card">
                                <div class="value">-</div>
                                <div class="label">Temas</div>
                            </div>
                            <div class="stat-card">
                                <div class="value">-</div>
                                <div class="label">Sentimiento</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Survey Panel -->
            <div class="panel survey-panel" id="surveyPanel">
                <div class="panel-header">
                    <h2 style="margin: 0; color: #e74c3c; font-size: 13px;">üó≥Ô∏è Panel de Encuestas</h2>
                </div>
                <div style="flex: 1; overflow-y: auto;">
                    <div style="background-color: white; padding: 12px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h3 style="margin-bottom: 12px; color: #2c3e50; font-size: 14px;">Encuestas Multi-Agente</h3>
                        
                        <div style="margin-bottom: 12px; padding: 10px; background-color: #f8f9fa; border-radius: 4px;">
                            <label style="font-weight: bold; color: #34495e; font-size: 12px;">Tipo de encuesta:</label>
                            <select id="surveySelect" style="width: 100%; padding: 6px; margin-top: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                <option value="">-- Selecciona una encuesta --</option>
                                <option value="electoral">Preferencias Electorales</option>
                                <option value="issues">Prioridades Pol√≠ticas</option>
                                <option value="values">Valores y Creencias</option>
                                <option value="social">Temas Sociales</option>
                            </select>
                            
                            <div style="margin-top: 10px;">
                                <label style="font-weight: bold; color: #34495e; font-size: 12px;">Agentes a encuestar:</label>
                                <div style="margin-bottom: 4px;">
                                    <label style="display: flex; align-items: center; cursor: pointer; font-size: 11px;">
                                        <input type="checkbox" id="selectAllAgents" style="margin-right: 6px;">
                                        <span style="font-weight: bold; color: #2c3e50;">Seleccionar todos</span>
                                    </label>
                                </div>
                                <div id="agentCheckboxes" style="margin-top: 6px; max-height: 150px; overflow-y: auto; padding: 8px; background-color: white; border-radius: 4px;">
                                    <p style="color: #7f8c8d; font-size: 11px;">Los agentes aparecer√°n aqu√≠ cuando los cargues</p>
                                </div>
                            </div>
                            
                            <button onclick="runMultiAgentSurvey()" style="margin-top: 10px; width: 100%; padding: 8px; background-color: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                ‚ñ∂Ô∏è Ejecutar Encuesta Multi-Agente
                            </button>
                        </div>
                        
                        <div id="surveyResults" style="display: none;">
                            <h4 style="color: #34495e; margin-bottom: 10px; font-size: 13px;">Resultados:</h4>
                            <div id="multiAgentResults"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Right Column -->
        <div class="right-panels">
            <!-- Chat Panel -->
            <div class="chat-wrapper" id="chatPanel">
                <div class="panel-header" style="background-color: white; padding: 8px; border-radius: 6px 6px 0 0;">
                    <h2 style="margin: 0; color: #2c3e50; font-size: 13px;">üí¨ Conversaci√≥n con <span id="chatAgentName">Agente</span></h2>
                </div>
                <div class="chat-container" style="border-radius: 0 0 10px 10px;">
                    <div class="messages" id="messages">
                        <div style="text-align: center; color: #7f8c8d; padding: 20px;">
                            <p>Selecciona un agente para comenzar la conversaci√≥n</p>
                        </div>
                    </div>
                    <div class="loading" id="loading">El agente est√° pensando...</div>
                    <div class="input-container">
                        <input 
                            type="text" 
                            id="messageInput" 
                            placeholder="Escribe tu mensaje..."
                            disabled
                        />
                        <button id="sendButton" disabled>Enviar</button>
                    </div>
                </div>
            </div>
            
            <!-- Experiment Panel -->
            <div class="panel experiment-panel" id="experimentPanel">
                <div class="panel-header"><h2 style="margin:0;color:#9b59b6;font-size:13px;">üß™ Experimentos Multi-Agente</h2></div>
                <div style="flex:1;overflow-y:auto;">
                <div style="background:#fff;padding:12px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,.1);">
                    <h3 style="font-size:12px;color:#2c3e50;margin-bottom:8px;">Dise√±o Experimental</h3>

                    <div style="margin-bottom:8px;">
                    <label style="font-size:11px;color:#34495e;font-weight:bold;">Experimento pre-configurado:</label>
                    <select id="presetExperimentSelect" onchange="onPresetChange()" style="width:100%;padding:4px;margin-top:3px;font-size:11px;border:1px solid #ddd;border-radius:4px;">
                        <option value="">-- Selecciona un experimento --</option>
                        <optgroup label="Seguridad y Orden">
                        <option value="matthei_military">Matthei: Militarizaci√≥n de la Araucan√≠a</option>
                        <option value="kast_security">Kast: Mano dura contra delincuencia</option>
                        <option value="toha_dialogue">Toh√°: Di√°logo en vez de represi√≥n</option>
                        </optgroup>
                        <optgroup label="Derechos Ind√≠genas">
                        <option value="recognition_const">Reconocimiento constitucional de pueblos originarios</option>
                        <option value="territorial_autonomy">Autonom√≠a territorial ind√≠gena</option>
                        </optgroup>
                        <optgroup label="Econom√≠a y Desarrollo">
                        <option value="investment_infra">Plan de inversi√≥n en infraestructura en La Araucan√≠a</option>
                        <option value="rural_subsidies">Subsidios a pymes rurales y agricultura familiar</option>
                        </optgroup>
                        <optgroup label="Controversias / Apoyos">
                        <option value="endorsement_mayors">Apoyo de alcaldes locales a plan de seguridad</option>
                        <option value="scandal_overreach">Cr√≠ticas por exceso de fuerza en operativo</option>
                        </optgroup>
                    </select>
                    </div>

                    <div id="presetDescription" style="display:none;margin-bottom:8px;padding:8px;background:#f8f9fa;border-radius:4px;font-size:10px;color:#555;"></div>

                    <!-- <div style="margin-bottom:10px;">
                    <label style="font-size:11px;color:#34495e;font-weight:bold;">Tipo de experimento:</label>
                    <select id="experimentType" style="width:100%;padding:4px;margin-top:3px;font-size:11px;border:1px solid #ddd;border-radius:4px;">
                        <option value="">-- Selecciona un tipo --</option>
                        <option value="framing">Efectos de Framing</option>
                        <option value="priming">Priming Pol√≠tico</option>
                        <option value="persuasion">Persuasi√≥n y Cambio de Opini√≥n</option>
                        <option value="social">Influencia Social</option>
                    </select>
                    </div> -->

                    <div style="margin-bottom:10px;">
                    <label style="font-size:11px;color:#34495e;font-weight:bold;">Mensaje experimental:</label>
                    <textarea id="experimentMessage" style="width:100%;height:90px;padding:6px;margin-top:3px;font-size:11px;border:1px solid #ddd;border-radius:4px;" placeholder="Escribe el mensaje o est√≠mulo experimental..."></textarea>
                    </div>

                    <div style="display:flex; gap:6px; flex-wrap:wrap;">
                    <button onclick="runMultiAgentExperiment()" style="flex:1; padding:6px; background:#9b59b6; color:white; border:none; border-radius:4px; cursor:pointer; font-size:11px;">‚ñ∂Ô∏è Ejecutar Experimento</button>
                    <button onclick="exportExperimentResultsCSV()" style="padding:6px 10px; background:#2ecc71; color:white; border:none; border-radius:4px; cursor:pointer; font-size:11px;">üìä Exportar CSV</button>
                    </div>

                    <div id="experimentResults" style="display:none; margin-top:10px;">
                    <h4 style="font-size:11px;color:#34495e;margin-bottom:6px;">Resultados del Experimento:</h4>
                    <div id="experimentResultsContent"></div>
                    </div>
                </div>
                </div>
            </div>
            </div>
        </div>
    
    <!-- Comparison Mode Modal -->
    <div class="modal-overlay" id="modalOverlay"></div>
    <div class="comparison-mode" id="comparisonMode">
        <div class="comparison-header">
            <h2 style="color: #2c3e50; font-size: 16px;">Comparaci√≥n de Respuestas Multi-Agente</h2>
            <button onclick="closeComparisonMode()" style="padding: 6px 12px; background-color: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">‚úï Cerrar</button>
        </div>
        
        <div style="margin-bottom: 15px;">
            <label style="font-size: 12px; color: #34495e; font-weight: bold;">Pregunta de comparaci√≥n:</label>
            <input type="text" id="comparisonQuestion" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;" placeholder="Ej: ¬øQu√© opinas sobre el sistema pol√≠tico actual?">
        </div>
        
        <button onclick="runComparison()" style="padding: 8px 16px; background-color: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; margin-bottom: 15px;">
            üîÑ Generar Comparaci√≥n
        </button>
        
        <div class="comparison-grid" id="comparisonGrid">
            <p style="text-align: center; color: #7f8c8d; grid-column: 1/-1;">Las respuestas aparecer√°n aqu√≠</p>
        </div>
    </div>
    
    <script>
        // Global variables
        let OPENAI_API_KEY = localStorage.getItem('openai_api_key') || '';
        let loadedAgents = [];
        let currentAgent = null;
        let conversationHistories = {};
        let isLoading = false;
        let lastSurveyPayload = null; // guarda el √∫ltimo resultado de runMultiAgentSurvey()
        
        // Sample agent structure for reference
        const sampleAgentStructure = {
            id: "agent_001",
            name: "Nombre del Agente",
            age: 28,
            gender: "F",
            occupation: "Ocupaci√≥n",
            location: "Comuna, Ciudad",
            education: "Nivel educativo",
            political_leaning: "Posici√≥n pol√≠tica",
            themes: ["tema1", "tema2", "tema3"],
            system_prompt: "Instrucciones detalladas para el agente...",
            interview_data: [
                {role: "user", content: "Pregunta..."},
                {role: "assistant", content: "Respuesta..."}
            ],
            metadata: {
                interview_date: "2024-01-01",
                interviewer: "Nombre",
                duration_minutes: 45,
                key_quotes: []
            }
        };
        
   
    // ========================= PRESETS DE EXPERIMENTOS ====================
    const PRESET_EXPERIMENTS = {
    // Seguridad y Orden
    matthei_military: {
        candidate: 'matthei',
        messageType: 'news',
        description: 'Propuesta de militarizaci√≥n permanente del territorio mapuche',
        message: `NOTICIA: Evelyn Matthei presenta plan de seguridad para La Araucan√≠a.\nLa candidata propone reforzar presencia militar en zonas de conflicto, priorizando el resguardo de rutas y la coordinaci√≥n con polic√≠as para enfrentar atentados.`,
        question: '¬øQue opinas sobre las propuestas de seguridad de la candidata Evelyn Matthei?'
    },
    kast_security: {
        candidate: 'kast',
        messageType: 'campaign',
        description: 'Promesa de mano dura contra delincuencia / terrorismo',
        message: `DECLARACI√ìN: Jos√© Antonio Kast promete \"mano dura\" contra el terrorismo.\nSe aplicar√° con fuerza la Ley de Seguridad del Estado y se impulsar√°n penas m√°s altas para delitos violentos y organizados en la zona.`,
        question: '¬øQue opinas sobre las propuestas de seguridad del candidato Jos√© Antonio Kast?'
    },
    toha_dialogue: {
        candidate: 'toha',
        messageType: 'policy',
        description: '√ânfasis en di√°logo y participaci√≥n multi-actor',
        message: `PROPUESTA: Carolina Toh√° impulsa mesa de trabajo multi-actor en La Araucan√≠a.\nSe prioriza el di√°logo con comunidades, pymes, municipios y actores regionales para abordar seguridad, desarrollo y derechos.`,
        question: '¬øQue opinas sobre las propuestas de seguridad de la candidata Carolina Toh√°?'
    },
    // Derechos Ind√≠genas
    recognition_const: {
        candidate: 'multi',
        messageType: 'policy',
        description: 'Reconocimiento constitucional de pueblos originarios',
        message: `PROPUESTA: Reconocimiento constitucional de los pueblos originarios.\nSe compromete el avance de un estatuto de reconocimiento y garant√≠as culturales y ling√º√≠sticas a nivel nacional.`,
        question: '¬øQue opinas sobre el reconocimiento constitucional de pueblos originarios?'
    },
    territorial_autonomy: {
        candidate: 'multi',
        messageType: 'policy',
        description: 'Autonom√≠a territorial ind√≠gena',
        message: `PROPUESTA: Dise√±o de una figura de autonom√≠a territorial ind√≠gena con competencias acotadas en desarrollo local, cultura y educaci√≥n, bajo est√°ndares internacionales.`,
        question: '¬øQue opinas sobre la autonom√≠a territorial ind√≠gena?'
    },
    // Econom√≠a y Desarrollo
    investment_infra: {
        candidate: 'multi',
        messageType: 'news',
        description: 'Plan de inversi√≥n en infraestructura para La Araucan√≠a',
        message: `NOTICIA: Plan de inversi√≥n p√∫blica en infraestructura regional.\nCarreteras, conectividad digital y fomento al turismo para dinamizar la econom√≠a y el empleo.`,
        question: '¬øQue opinas sobre la inversi√≥n en infraestructura para La Araucan√≠a?'
    },
    rural_subsidies: {
        candidate: 'multi',
        messageType: 'policy',
        description: 'Subsidios a pymes rurales y agricultura familiar',
        message: `PROPUESTA: Programa de subsidios y cr√©ditos blandos para pymes rurales y agricultura familiar, con asistencia t√©cnica y encadenamientos productivos.`,
        question: '¬øQue opinas sobre subsidios a pymes rurales y agricultura familiar?'
    },
    // Controversias / Apoyos
    endorsement_mayors: {
        candidate: 'multi',
        messageType: 'endorsement',
        description: 'Apoyo de alcaldes locales a plan de seguridad',
        message: `APOYO: Asociaci√≥n de alcaldes de la zona respalda plan de seguridad y coordinaci√≥n interinstitucional.\nSe destaca la reducci√≥n de tiempos de respuesta y mayor sensaci√≥n de control.`,
        question: '¬øQu√© piensas del respaldo de alcaldes a la seguridad?'
    },
    scandal_overreach: {
        candidate: 'multi',
        messageType: 'scandal',
        description: 'Cr√≠ticas por supuesto exceso de fuerza en operativo',
        message: `CONTROVERSIA: Organizaciones denuncian uso excesivo de la fuerza en operativo reciente.\nPiden protocolos m√°s estrictos y supervisi√≥n independiente.`,
        question: '¬øQue opinas sobre el uso excesivo de la fuerza?'
    }
    };

    function nameForCandidate(id){
      const map={matthei:'Evelyn Matthei', kast:'Jos√© Antonio Kast', toha:'Carolina Toh√°', boric:'Gabriel Boric', jadue:'Daniel Jadue', multi:'Varios'};
      return map[id]||id;
    }
    function nameForMsgType(t){
      const map={news:'Noticia', campaign:'Mensaje de campa√±a', policy:'Propuesta pol√≠tica', scandal:'Controversia', endorsement:'Apoyo'};
      return map[t]||t;
    }


        // Check API key on load
        window.addEventListener('load', function() {
            if (!OPENAI_API_KEY) {
                document.getElementById('apiKeyOverlay').classList.remove('hidden');
            } else {
                document.getElementById('apiKeyOverlay').classList.add('hidden');
            }
            
            // Load any saved agents from localStorage
            const savedAgents = localStorage.getItem('loaded_agents');
            if (savedAgents) {
                try {
                    loadedAgents = JSON.parse(savedAgents);
                    updateAgentSelector();
                    updateAgentCheckboxes();
                } catch (e) {
                    console.error('Error loading saved agents:', e);
                }
            }
        });
        
        // API Key Management
        function saveApiKey() {
            const input = document.getElementById('apiKeyInput');
            const apiKey = input.value.trim();
            const errorEl = document.getElementById('apiKeyError');
            
            if (!apiKey || !apiKey.startsWith('sk-')) {
                errorEl.style.display = 'block';
                return;
            }
            
            OPENAI_API_KEY = apiKey;
            localStorage.setItem('openai_api_key', apiKey);
            
            document.getElementById('apiKeyOverlay').classList.add('hidden');
            errorEl.style.display = 'none';
        }
        
        function changeApiKey() {
            document.getElementById('apiKeyInput').value = '';
            document.getElementById('apiKeyOverlay').classList.remove('hidden');
            document.getElementById('apiKeyInput').focus();
        }
        
        // Load agents from JSON file
        function loadAgentsFromFile(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            let filesProcessed = 0;
            let agentsAdded = 0;
            let errors = [];

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        let newAgents = [];
                        if (Array.isArray(data)) {
                            newAgents = data;
                        } else if (data.agents && Array.isArray(data.agents)) {
                            newAgents = data.agents;
                        } else {
                            newAgents = [data];
                        }
                        newAgents = newAgents.map(agent => validateAgentStructure(agent));
                        loadedAgents = loadedAgents.concat(newAgents);
                        agentsAdded += newAgents.length;
                    } catch (error) {
                        console.error('Error parsing JSON:', error);
                        errors.push(file.name);
                    }
                    filesProcessed++;
                    if (filesProcessed === files.length) {
                        // Remove duplicates by id
                        const seen = new Set();
                        loadedAgents = loadedAgents.filter(agent => {
                            if (seen.has(agent.id)) return false;
                            seen.add(agent.id);
                            return true;
                        });
                        // Save to localStorage
                        localStorage.setItem('loaded_agents', JSON.stringify(loadedAgents));
                        // Update UI
                        updateAgentSelector();
                        updateAgentCheckboxes();
                        if (agentsAdded > 0) {
                            showNotification(`Se cargaron ${agentsAdded} agente(s) de ${files.length} archivo(s)`);
                        }
                        if (errors.length > 0) {
                            showNotification(`Error al procesar: ${errors.join(', ')}`, 'error');
                        }
                    }
                };
                reader.readAsText(file);
            }
        }
        
        // Validate and normalize agent structure
        function validateAgentStructure(agent) {
            // Ensure required fields
            if (!agent.id) agent.id = 'agent_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            if (!agent.name) agent.name = 'Agente Sin Nombre';
            if (!agent.system_prompt) agent.system_prompt = generateDefaultSystemPrompt(agent);
            if (!agent.interview_data || !Array.isArray(agent.interview_data)) agent.interview_data = [];
            
            // Initialize conversation history for this agent
            if (!conversationHistories[agent.id]) {
                conversationHistories[agent.id] = [...agent.interview_data];
            }
            
            return agent;
        }
        
        // Generate default system prompt if not provided
        function generateDefaultSystemPrompt(agent) {
            return `Eres ${agent.name}, ${agent.age ? agent.age + ' a√±os' : ''}, ${agent.occupation || 'sin ocupaci√≥n especificada'}. 
                    Vives en ${agent.location || 'ubicaci√≥n no especificada'}. 
                    Responde de manera consistente con tu perfil y experiencias. 
                    Mant√©n un tono conversacional y aut√©ntico.`;
        }
        
        // Update agent selector dropdown
        function updateAgentSelector() {
            const selector = document.getElementById('agentSelector');
            selector.innerHTML = '<option value="">-- Selecciona un agente --</option>';
            
            loadedAgents.forEach(agent => {
                const option = document.createElement('option');
                option.value = agent.id;
                option.textContent = `${agent.name} (${agent.age || '?'} a√±os, ${agent.location || 'Sin ubicaci√≥n'})`;
                selector.appendChild(option);
            });
        }
        
        // Update agent checkboxes for surveys
        function updateAgentCheckboxes() {
            const container = document.getElementById('agentCheckboxes');
            const selectAll = document.getElementById('selectAllAgents');
            if (loadedAgents.length === 0) {
                container.innerHTML = '<p style="color: #7f8c8d; font-size: 11px;">No hay agentes cargados</p>';
                if (selectAll) selectAll.checked = false;
                return;
            }
            container.innerHTML = loadedAgents.map(agent => `
                <div style="margin-bottom: 4px;">
                    <label style="display: flex; align-items: center; cursor: pointer; font-size: 11px;">
                        <input type="checkbox" value="${agent.id}" class="agent-checkbox" style="margin-right: 6px;">
                        <span>${agent.name} (${agent.age || '?'})</span>
                    </label>
                </div>
            `).join('');
            // L√≥gica para seleccionar todos
            if (selectAll) {
                selectAll.checked = false;
                selectAll.onclick = function() {
                    const agentCbs = container.querySelectorAll('.agent-checkbox');
                    agentCbs.forEach(cb => { cb.checked = selectAll.checked; });
                };
            }
            // Si el usuario selecciona/deselecciona manualmente, actualizar el checkbox global
            container.querySelectorAll('.agent-checkbox').forEach(cb => {
                cb.addEventListener('change', function() {
                    const all = container.querySelectorAll('.agent-checkbox');
                    const checked = container.querySelectorAll('.agent-checkbox:checked');
                    if (selectAll) selectAll.checked = (all.length > 0 && checked.length === all.length);
                });
            });
        }
        
        // Switch active agent
        function switchAgent() {
            const agentId = document.getElementById('agentSelector').value;
            
            if (!agentId) {
                currentAgent = null;
                resetUI();
                return;
            }
            
            currentAgent = loadedAgents.find(a => a.id === agentId);
            if (!currentAgent) return;
            
            // Update UI with agent info
            updateAgentUI();
            
            // Load conversation history
            displayConversation();
            
            // Enable chat
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendButton').disabled = false;
        }
        
        // Update UI with current agent information
        function updateAgentUI() {
            if (!currentAgent) return;
            
            // Update agent info bar
            document.getElementById('agentInfo').style.display = 'flex';
            document.getElementById('agentName').textContent = currentAgent.name;
            document.getElementById('agentLocation').textContent = currentAgent.location || 'Sin ubicaci√≥n';
            document.getElementById('agentInterviews').textContent = `${currentAgent.interview_data.length / 2} intercambios`;
            
            // Update chat header
            document.getElementById('chatAgentName').textContent = currentAgent.name;
            
            // Update profile card
            document.getElementById('agentProfileCard').style.display = 'block';
            document.getElementById('profileName').textContent = currentAgent.name;
            document.getElementById('profileAge').textContent = currentAgent.age || '-';
            document.getElementById('profileGender').textContent = currentAgent.gender || '-';
            document.getElementById('profileOccupation').textContent = currentAgent.occupation || '-';
            document.getElementById('profileLocation').textContent = currentAgent.location || '-';
            
            // Update overview
            updateAgentOverview();
            
            // Update themes
            updateAgentThemes();
            
            // Update stats
            updateAgentStats();
        }
        
        // Update agent overview
        function updateAgentOverview() {
            const overview = document.getElementById('agentOverview');
            
            const summary = `
                <div style="text-align: left;">
                    <h3 style="color: #2c3e50; margin-bottom: 10px; font-size: 14px;">Resumen del Agente</h3>
                    <p style="color: #555; line-height: 1.5; font-size: 12px; margin-bottom: 10px;">
                        ${currentAgent.name} es ${currentAgent.occupation || 'trabajador'} de ${currentAgent.age || 'edad no especificada'} a√±os, 
                        residente en ${currentAgent.location || 'ubicaci√≥n no especificada'}.
                    </p>
                    ${currentAgent.political_leaning ? `
                        <p style="color: #555; line-height: 1.5; font-size: 12px; margin-bottom: 10px;">
                            <strong>Posici√≥n pol√≠tica:</strong> ${currentAgent.political_leaning}
                        </p>
                    ` : ''}
                    ${currentAgent.education ? `
                        <p style="color: #555; line-height: 1.5; font-size: 12px; margin-bottom: 10px;">
                            <strong>Educaci√≥n:</strong> ${currentAgent.education}
                        </p>
                    ` : ''}
                    <p style="color: #7f8c8d; font-size: 11px;">
                        <strong>Total de intercambios:</strong> ${currentAgent.interview_data.length / 2}
                    </p>
                </div>
            `;
            
            overview.innerHTML = summary;
        }
        
        // Update agent themes
        function updateAgentThemes() {
            const themesDiv = document.getElementById('agentThemes');
            
            if (!currentAgent.themes || currentAgent.themes.length === 0) {
                themesDiv.innerHTML = '<p style="color: #7f8c8d;">No hay temas definidos para este agente</p>';
                return;
            }
            
            const themesHTML = `
                <div>
                    <h3 style="color: #2c3e50; margin-bottom: 10px; font-size: 14px;">Temas Principales</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                        ${currentAgent.themes.map(theme => `
                            <span style="display: inline-block; padding: 6px 12px; background-color: #3498db; color: white; border-radius: 15px; font-size: 11px;">
                                ${theme}
                            </span>
                        `).join('')}
                    </div>
                </div>
            `;
            
            themesDiv.innerHTML = themesHTML;
        }
        
        // Update agent statistics
        function updateAgentStats() {
            const stats = calculateAgentStats();
            
            document.getElementById('agentStats').innerHTML = `
                <div class="stat-card">
                    <div class="value">${stats.messages}</div>
                    <div class="label">Mensajes</div>
                </div>
                <div class="stat-card">
                    <div class="value">${stats.words}</div>
                    <div class="label">Palabras</div>
                </div>
                <div class="stat-card">
                    <div class="value">${stats.themes}</div>
                    <div class="label">Temas</div>
                </div>
                <div class="stat-card">
                    <div class="value">${stats.avgLength}</div>
                    <div class="label">Prom. Palabras</div>
                </div>
            `;
        }
        
        // Calculate agent statistics
        function calculateAgentStats() {
            if (!currentAgent) return { messages: 0, words: 0, themes: 0, avgLength: 0 };
            
            const agentMessages = currentAgent.interview_data.filter(m => m.role === 'assistant');
            const totalWords = agentMessages.reduce((sum, msg) => sum + msg.content.split(' ').length, 0);
            const avgLength = agentMessages.length > 0 ? Math.round(totalWords / agentMessages.length) : 0;
            
            return {
                messages: agentMessages.length,
                words: totalWords,
                themes: currentAgent.themes ? currentAgent.themes.length : 0,
                avgLength: avgLength
            };
        }
        
        // Display conversation history
        function displayConversation() {
            const messagesEl = document.getElementById('messages');
            
            if (!currentAgent) {
                messagesEl.innerHTML = '<div style="text-align: center; color: #7f8c8d; padding: 20px;"><p>Selecciona un agente para ver la conversaci√≥n</p></div>';
                return;
            }
            
            const history = conversationHistories[currentAgent.id] || currentAgent.interview_data;
            
            if (history.length === 0) {
                messagesEl.innerHTML = '<div style="text-align: center; color: #7f8c8d; padding: 20px;"><p>No hay conversaci√≥n previa con este agente</p></div>';
                return;
            }
            
            messagesEl.innerHTML = history.map(msg => `
                <div class="message ${msg.role}">
                    ${msg.content}
                </div>
            `).join('');
            
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }
        
        // Send message to current agent
        async function sendMessage() {
            if (!currentAgent || isLoading || !OPENAI_API_KEY) return;
            
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            isLoading = true;
            input.value = '';
            input.disabled = true;
            document.getElementById('sendButton').disabled = true;
            
            // Add user message to history
            if (!conversationHistories[currentAgent.id]) {
                conversationHistories[currentAgent.id] = [...currentAgent.interview_data];
            }
            conversationHistories[currentAgent.id].push({ role: 'user', content: message });
            displayConversation();
            
            // Show loading
            document.getElementById('loading').classList.add('show');
            
            try {
                // Prepare messages for API
                const messages = [
                    { role: 'system', content: currentAgent.system_prompt },
                    ...conversationHistories[currentAgent.id]
                ];
                
                // Call OpenAI API
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + OPENAI_API_KEY
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o-mini',
                        messages: messages,
                        temperature: 0.7,
                        max_tokens: 500
                    })
                });
                
                const data = await response.json();
                
                if (data.choices && data.choices[0]) {
                    conversationHistories[currentAgent.id].push({ 
                        role: 'assistant', 
                        content: data.choices[0].message.content 
                    });
                    displayConversation();
                } else {
                    throw new Error('Invalid response from API');
                }
                
            } catch (error) {
                console.error('Error:', error);
                showNotification('‚ùå Error al obtener respuesta. Verifica tu API key.', 'error');
            } finally {
                isLoading = false;
                input.disabled = false;
                document.getElementById('sendButton').disabled = false;
                document.getElementById('loading').classList.remove('show');
                input.focus();
            }
        }
        
        // Multi-agent survey
        async function runMultiAgentSurvey() {
            const surveyType = document.getElementById('surveySelect').value;
            if (!surveyType) {
                showNotification('‚ö†Ô∏è Selecciona un tipo de encuesta', 'warning');
                return;
            }
            
            const selectedAgents = Array.from(document.querySelectorAll('#agentCheckboxes input:checked'))
                .map(cb => cb.value);
            
            if (selectedAgents.length === 0) {
                showNotification('‚ö†Ô∏è Selecciona al menos un agente', 'warning');
                return;
            }
            
            document.getElementById('surveyResults').style.display = 'block';
            document.getElementById('multiAgentResults').innerHTML = '<p style="text-align: center; color: #7f8c8d;">‚è≥ Ejecutando encuesta...</p>';
            
            const surveyQuestions = getSurveyQuestions(surveyType);
            const results = [];
            
            for (const agentId of selectedAgents) {
                const agent = loadedAgents.find(a => a.id === agentId);
                if (!agent) continue;
                
                const agentResults = await conductSurvey(agent, surveyQuestions);
                results.push({ agent, responses: agentResults });
            }
            
            lastSurveyPayload = {
            type: surveyType,
            results, // [{ agent, responses: [{question, answer}, ...] }, ...]
            timestamp: new Date().toISOString()
            };

            displaySurveyResults(results, surveyType);
        }
        
        // Exportaci√≥n de Experiment Results
        function exportExperimentResultsCSV(){
            const header = [
                'presetKey', 'presetLabel', 'timestamp',
                'agent_id', 'agent_name', 'agent_location',
                'question',
                'baseline_text', 'baseline_score', 'baseline_label',
                'treatment_text', 'treatment_score', 'treatment_label',
                'delta_score', 'direction'
            ];
            const rows = [header];
            for (const { agent, question, baseline, treatment, change } of lastExperimentPayload.results) {
                rows.push([
                lastExperimentPayload.presetKey || '',
                lastExperimentPayload.presetLabel || '',
                lastExperimentPayload.timestamp || '',
                agent.id || '',
                agent.name || '',
                agent.location || '',
                question || '',
                baseline || '',
                change?.baselineScore ?? '',
                change?.baselineLabel ?? '',
                treatment || '',
                change?.treatmentScore ?? '',
                change?.treatmentLabel ?? '',
                change?.delta ?? '',
                change?.direction ?? ''
                ]);
            }
            const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(',')).join('\r\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `experimento_${lastExperimentPayload.presetKey}_${Date.now()}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification('üì• Experimento exportado como CSV');
        }

        // Get survey questions based on type
        function getSurveyQuestions(type) {
            const questions = {
                electoral: [
                    "Si las elecciones fueran ma√±ana, ¬øpor qui√©n votar√≠as?",
                    "¬øQu√© tan satisfecho est√°s con el gobierno actual?",
                    "¬øCu√°l es el problema m√°s importante que enfrenta el pa√≠s?"
                ],
                issues: [
                    "¬øCu√°l deber√≠a ser la prioridad del gobierno?",
                    "¬øQu√© opinas sobre la situaci√≥n econ√≥mica actual?",
                    "¬øC√≥mo eval√∫as la seguridad en tu comuna?"
                ],
                values: [
                    "¬øQu√© es m√°s importante: libertad o seguridad?",
                    "¬øEl Estado deber√≠a tener m√°s o menos intervenci√≥n en la econom√≠a?",
                    "¬øQu√© opinas sobre los movimientos sociales actuales?"
                ],
                social: [
                    "¬øQu√© opinas sobre la inmigraci√≥n?",
                    "¬øC√≥mo ves el tema de g√©nero en la sociedad actual?",
                    "¬øQu√© piensas sobre el cambio clim√°tico?"
                ]
            };
            
            return questions[type] || [];
        }
        
        // Conduct survey with an agent
        async function conductSurvey(agent, questions) {
            const responses = [];
            
            for (const question of questions) {
                try {
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + OPENAI_API_KEY
                        },
                        body: JSON.stringify({
                            model: 'gpt-4o-mini',
                            messages: [
                                { role: 'system', content: agent.system_prompt },
                                ...agent.interview_data.slice(-6),
                                { role: 'user', content: `Responde brevemente (m√°ximo 2-3 oraciones) a esta pregunta: ${question}` }
                            ],
                            temperature: 0.7,
                            max_tokens: 150
                        })
                    });
                    
                    const data = await response.json();
                    responses.push({
                        question,
                        answer: data.choices[0].message.content
                    });
                } catch (error) {
                    responses.push({
                        question,
                        answer: 'Error al obtener respuesta'
                    });
                }
            }
            
            return responses;
        }
        
        // Display survey results
        function displaySurveyResults(results, surveyType) {
            const container = document.getElementById('multiAgentResults');
            
            let html = '<div style="max-height: 400px; overflow-y: auto;">';
            
            results.forEach(({ agent, responses }) => {
                html += `
                    <div style="margin-bottom: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 6px;">
                        <h4 style="color: #2c3e50; margin-bottom: 8px; font-size: 13px;">
                            ${agent.name} (${agent.age || '?'} a√±os, ${agent.location || 'Sin ubicaci√≥n'})
                        </h4>
                        ${responses.map(r => `
                            <div style="margin-bottom: 8px;">
                                <p style="font-weight: bold; color: #34495e; font-size: 11px; margin-bottom: 3px;">
                                    ${r.question}
                                </p>
                                <p style="color: #555; font-size: 11px; padding-left: 10px; font-style: italic;">
                                    "${r.answer}"
                                </p>
                            </div>
                        `).join('')}
                    </div>
                `;
            });
            
            html += '</div>';
            
            html += `
                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd;">
                    <button onclick="exportSurveyResults('${surveyType}')" style="padding: 6px 12px; background-color: #2ecc71; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
                        üìä Exportar Resultados
                    </button>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // Export survey results
        function exportSurveyResults(surveyType) {
            // 1) Verificaciones
            if (!lastSurveyPayload || !lastSurveyPayload.results || lastSurveyPayload.results.length === 0) {
                showNotification('‚ö†Ô∏è No hay resultados de encuesta para exportar', 'warning');
                return;
            }

            // 2) Armar filas para CSV
            // Columnas: survey_type, timestamp, agent_id, agent_name, agent_age, agent_location, question, answer
            const header = [
                'survey_type',
                'timestamp',
                'agent_id',
                'agent_name',
                'agent_age',
                'agent_location',
                'question',
                'answer'
            ];

            const rows = [header];

            for (const { agent, responses } of lastSurveyPayload.results) {
                for (const r of responses) {
                    rows.push([
                        lastSurveyPayload.type || surveyType || '',
                        lastSurveyPayload.timestamp || '',
                        agent.id || '',
                        agent.name || '',
                        agent.age != null ? agent.age : '',
                        agent.location || '',
                        r.question || '',
                        r.answer || ''
                    ]);
                }
            }

            // 3) Convertir a CSV seguro (escapando comillas y saltos de l√≠nea)
            const csv = rows.map(cols =>
                cols.map(v => {
                    const s = String(v).replace(/"/g, '""');
                    return `"${s}"`;
                }).join(',')
            ).join('\r\n');

            // 4) Descargar
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const fileName = `encuesta_${lastSurveyPayload.type || surveyType || 'multi'}_${Date.now()}.csv`;

            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showNotification('Resultados exportados como CSV');
        }

        // ========================= EXPERIMENTOS ==============================
        function onPresetChange(){
            const sel=document.getElementById('presetExperimentSelect').value;
            const descDiv=document.getElementById('presetDescription');
            const msgBox=document.getElementById('experimentMessage');
            if(!sel){ descDiv.style.display='none'; return; }
            const exp=PRESET_EXPERIMENTS[sel]; if(!exp) return;
            // Mostrar tanto el mensaje como la pregunta en el textarea (separados por salto de l√≠nea)
            msgBox.value = `${exp.message}\n\nPREGUNTA: ${exp.question}`;
            descDiv.innerHTML = `<strong>Descripci√≥n:</strong> ${exp.description}<br><strong>Candidato:</strong> ${nameForCandidate(exp.candidate)}<br><strong>Tipo:</strong> ${nameForMsgType(exp.messageType)}<br><strong>Pregunta:</strong> ${exp.question}`;
            descDiv.style.display='block';
        }


        /**
         * Lanza el experimento multi-agente usando el PRESET seleccionado.
         * - Lee presetKey desde un <select id="presetSelect"> (o acepta un arg opcional).
         * - Muestra en UI el mensaje y la pregunta del preset.
         * - Llama a runExperimentOnAgents(presetKey) (que ya usa preset.message y preset.question).
         * - Guarda lastExperimentPayload y muestra resultados.
         */
        async function runMultiAgentExperiment(presetKeyArg = null) {
            const runBtn = document.getElementById('runExperimentBtn');
            const presetSelect = document.getElementById('presetSelect'); // opcional
            const presetKey = presetKeyArg
                || (presetSelect && presetSelect.value)
                || Object.keys(PRESET_EXPERIMENTS)[0];

            const preset = PRESET_EXPERIMENTS[presetKey];
            if (!preset) {
                console.error('Preset no encontrado:', presetKey);
                showNotification?.('Preset no encontrado', 'error');
                return;
            }

            // Permitir edici√≥n del mensaje y pregunta antes de correr el experimento
            const msgBox = document.getElementById('experimentMessage');
            let customMessage = msgBox && msgBox.value ? msgBox.value : preset.message;
            // Si el usuario edita el textarea, puede estar en formato "mensaje\n\nPREGUNTA: ..."
            let customQuestion = preset.question;
            const questionMatch = customMessage.match(/PREGUNTA:\s*(.+)$/s);
            if (questionMatch) {
                customMessage = customMessage.replace(/\n*PREGUNTA:.+$/s, '').trim();
                customQuestion = questionMatch[1].trim();
            }
            // UI: muestra el mensaje y la pregunta actual (editados o del preset)
            const presetLabelEl   = document.getElementById('currentPresetLabel');
            const presetMsgEl     = document.getElementById('currentPresetMessage');
            const presetQEl       = document.getElementById('currentPresetQuestion');

            if (presetLabelEl) presetLabelEl.textContent = preset.description || presetKey;
            if (presetMsgEl)   presetMsgEl.textContent   = customMessage || '';
            if (presetQEl)     presetQEl.textContent     = customQuestion || '';

            try {
                if (runBtn) {
                    runBtn.disabled = true;
                    runBtn.dataset.originalText = runBtn.textContent;
                    runBtn.textContent = 'Corriendo‚Ä¶';
                }

                // Show results section and loading message
                document.getElementById('experimentResults').style.display = 'block';
                document.getElementById('experimentResultsContent').innerHTML = '<p style="text-align: center; color: #7f8c8d; font-size: 11px;">‚è≥ Ejecutando experimento...</p><p style="text-align: center; color: #95a5a6; font-size: 10px; margin-top: 5px;">Realizando m√∫ltiples mediciones para mayor precisi√≥n...</p>';

                // Ejecuta el experimento usando los valores editados
                const results = await runExperimentOnAgents(presetKey, customMessage, customQuestion);

                // Persistimos payload para exportaci√≥n/inspecci√≥n
                lastExperimentPayload = {
                    presetKey,
                    presetLabel: preset.description || presetKey,
                    message: customMessage,
                    question: customQuestion,
                    timestamp: new Date().toISOString(),
                    results
                };

                // Pinta resultados (term√≥metro 0‚Äì100 ya lo maneja displayExperimentResults)
                displayExperimentResults?.(results);

                showNotification?.('Experimento completado');
            } catch (err) {
                console.error('runMultiAgentExperiment error:', err);
                showNotification?.('Error ejecutando el experimento', 'error');
            } finally {
                if (runBtn) {
                    runBtn.disabled = false;
                    runBtn.textContent = runBtn.dataset.originalText || 'Correr experimento';
                }
            }
        }
        /**
         * Ejecuta el experimento en todos los agentes.
         * @param {string} presetKey - Clave del preset
         * @param {string} [customMessage] - Mensaje personalizado (opcional)
         * @param {string} [customQuestion] - Pregunta personalizada (opcional)
         */
        async function runExperimentOnAgents(presetKey, customMessage, customQuestion) {
            const preset = PRESET_EXPERIMENTS[presetKey];
            if (!preset) throw new Error('Preset no encontrado: ' + presetKey);
            // Usar los argumentos si est√°n definidos, si no, usar los del preset
            const msg = typeof customMessage === 'string' ? customMessage : preset.message;
            const question = typeof customQuestion === 'string' ? customQuestion : preset.question;

            const results = [];
            for (const agent of loadedAgents) {
                const baselineQ = `PREGUNTA:\n${question}\n\nPor favor, responde SIEMPRE iniciando tu respuesta con un n√∫mero entre 0 y 100 (donde 0 es muy negativo y 100 es muy positivo) indicando tu sentimiento, seguido de una breve explicaci√≥n.`;
                const baseline = await getAgentResponse(agent, baselineQ);

                const treatmentPrompt = `MENSAJE:\n${msg}\n\nPREGUNTA:\n${question}\n\nPor favor, responde SIEMPRE iniciando tu respuesta con un n√∫mero entre 0 y 100 (donde 0 es muy negativo y 100 es muy positivo) indicando tu sentimiento, seguido de una breve explicaci√≥n.`;
                const treatment = await getAgentResponse(agent, treatmentPrompt);

                const change = await analyzeChange(baseline, treatment);

                results.push({
                    agent,
                    presetLabel: preset.description,
                    question,
                    baseline,
                    treatment,
                    change
                });
            }

            lastExperimentPayload = {
                presetKey,
                presetLabel: preset.description,
                timestamp: new Date().toISOString(),
                results
            };

            return results;
        }
        
        
        // Get agent response
        async function getAgentResponse(agent, prompt) {
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + OPENAI_API_KEY
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o-mini',
                        messages: [
                            { role: 'system', content: agent.system_prompt },
                            ...agent.interview_data.slice(-4),
                            { role: 'user', content: prompt }
                        ],
                        temperature: 0.7,
                        max_tokens: 200
                    })
                });
                
                const data = await response.json();
                return data.choices[0].message.content;
            } catch (error) {
                return 'Error al obtener respuesta';
            }
        }
        
        // Analyze change between responses
        function analyzeChange(baseline, treatment) {
            // Extrae el primer n√∫mero entre 0 y 100 de cada respuesta, tolerando formatos tipo "100:" o "100 - explicaci√≥n"
            function extractScore(text) {
                if (!text) return null;
                // Busca n√∫mero al inicio, o tras espacios, dos puntos, guiones, etc.
                const match = text.match(/(?:^|[\s:,-])([0-9]{1,3})(?=\D|$)/);
                if (!match) return null;
                let num = parseInt(match[1], 10);
                if (isNaN(num)) return null;
                if (num < 0) num = 0;
                if (num > 100) num = 100;
                return num;
            }
            const baselineScore = extractScore(baseline);
            const treatmentScore = extractScore(treatment);
            let delta = null, direction = '', percent = '';
            if (baselineScore !== null && treatmentScore !== null) {
                delta = treatmentScore - baselineScore;
                direction = delta > 0 ? 'mejora' : delta < 0 ? 'empeora' : 'sin cambio';
                percent = baselineScore !== 0 ? ((delta / baselineScore) * 100).toFixed(1) + '%' : '';
            }
            return {
                baselineScore,
                treatmentScore,
                delta,
                percent,
                direction
            };
        }
        
        // Display experiment results
        function displayExperimentResults(results) {
            const container = document.getElementById('experimentResultsContent');
            // Mostrar el contenedor de resultados
            const resultsBox = document.getElementById('experimentResults');
            if (resultsBox) resultsBox.style.display = 'block';

            let html = '<div style="max-height: 350px; overflow-y: auto;">';

            results.forEach(({ agent, baseline, treatment, change }) => {
                html += `
                    <div style="margin-bottom: 12px; padding: 10px; background-color: #f8f9fa; border-radius: 6px;">
                        <h4 style="color: #2c3e50; margin-bottom: 6px; font-size: 12px;">${agent.name}</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <div>
                                <p style="font-weight: bold; color: #7f8c8d; font-size: 10px; margin-bottom: 3px;">Baseline:</p>
                                <p style="color: #555; font-size: 10px; line-height: 1.3;">"${baseline.substring(0, 200)}..."</p>
                                <p style="color:#888;font-size:10px;">Puntaje: <strong>${change.baselineScore ?? '-'}</strong></p>
                            </div>
                            <div>
                                <p style="font-weight: bold; color: #7f8c8d; font-size: 10px; margin-bottom: 3px;">Tratamiento:</p>
                                <p style="color: #555; font-size: 10px; line-height: 1.3;">"${treatment.substring(0, 200)}..."</p>
                                <p style="color:#888;font-size:10px;">Puntaje: <strong>${change.treatmentScore ?? '-'}</strong></p>
                            </div>
                        </div>
                        <div style="margin-top: 6px; padding-top: 6px; border-top: 1px solid #ddd;">
                            <span style="font-size: 10px; color: #34495e;">
                                <strong>Cambio:</strong> `;
                if (change.baselineScore !== null && change.treatmentScore !== null && change.delta !== null && change.direction) {
                    html += `${change.delta > 0 ? '+' : ''}${change.delta} (${change.direction}${change.percent ? ', ' + change.percent : ''})`;
                } else {
                    html += 'No se pudo calcular el cambio (respuestas no num√©ricas)';
                }
                html += `</span>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }
        
        // Comparison mode functions
        function openComparisonMode() {
            if (loadedAgents.length < 2) {
                showNotification('‚ö†Ô∏è Necesitas al menos 2 agentes para comparar', 'warning');
                return;
            }
            
            document.getElementById('modalOverlay').classList.add('active');
            document.getElementById('comparisonMode').classList.add('active');
        }
        
        function closeComparisonMode() {
            document.getElementById('modalOverlay').classList.remove('active');
            document.getElementById('comparisonMode').classList.remove('active');
        }
        
        async function runComparison() {
            const question = document.getElementById('comparisonQuestion').value.trim();
            
            if (!question) {
                showNotification('‚ö†Ô∏è Ingresa una pregunta para comparar', 'warning');
                return;
            }
            
            const grid = document.getElementById('comparisonGrid');
            grid.innerHTML = '<p style="text-align: center; color: #7f8c8d; grid-column: 1/-1;">‚è≥ Generando respuestas...</p>';
            
            const responses = [];
            
            for (const agent of loadedAgents) {
                const response = await getAgentResponse(agent, question);
                responses.push({ agent, response });
            }
            
            displayComparisonResults(responses);
        }
        
        function displayComparisonResults(responses) {
            const grid = document.getElementById('comparisonGrid');
            
            grid.innerHTML = responses.map(({ agent, response }) => `
                <div class="comparison-agent">
                    <h4>${agent.name}</h4>
                    <div style="font-size: 10px; color: #7f8c8d; margin-bottom: 5px;">
                        ${agent.age || '?'} a√±os, ${agent.location || 'Sin ubicaci√≥n'}
                    </div>
                    <div class="comparison-response">
                        "${response}"
                    </div>
                </div>
            `).join('');
        }
        
        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            document.querySelectorAll('.dashboard-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
        }
        
        // Reset UI when no agent is selected
        function resetUI() {
            document.getElementById('agentInfo').style.display = 'none';
            document.getElementById('agentProfileCard').style.display = 'none';
            document.getElementById('chatAgentName').textContent = 'Agente';
            document.getElementById('messages').innerHTML = '<div style="text-align: center; color: #7f8c8d; padding: 20px;"><p>Selecciona un agente para comenzar la conversaci√≥n</p></div>';
            document.getElementById('messageInput').disabled = true;
            document.getElementById('sendButton').disabled = true;
            
            document.getElementById('agentOverview').innerHTML = '<p style="text-align: center; color: #7f8c8d;">No hay agente seleccionado</p>';
            document.getElementById('agentThemes').innerHTML = '<p style="text-align: center; color: #7f8c8d;">Los temas aparecer√°n aqu√≠ cuando selecciones un agente</p>';
            
            document.getElementById('agentStats').innerHTML = `
                <div class="stat-card">
                    <div class="value">-</div>
                    <div class="label">Mensajes</div>
                </div>
                <div class="stat-card">
                    <div class="value">-</div>
                    <div class="label">Palabras</div>
                </div>
                <div class="stat-card">
                    <div class="value">-</div>
                    <div class="label">Temas</div>
                </div>
                <div class="stat-card">
                    <div class="value">-</div>
                    <div class="label">Sentimiento</div>
                </div>
            `;
        }
        
        // Show notification
        function showNotification(message, type = 'success') {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                background-color: ${type === 'error' ? '#e74c3c' : type === 'warning' ? '#f39c12' : type === 'info' ? '#3498db' : '#2ecc71'};
                color: white;
                border-radius: 6px;
                font-size: 13px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 3000;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            
            // Add animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }
        
        // Event listeners for Enter key
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        document.getElementById('sendButton').addEventListener('click', sendMessage);
        
        document.getElementById('apiKeyInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                saveApiKey();
            }
        });
        
        // Drag and drop support for file upload
        const dropZone = document.body;
        
        dropZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
        });
        
        dropZone.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type === 'application/json') {
                const fileInput = document.getElementById('agentFileInput');
                fileInput.files = files;
                loadAgentsFromFile({ target: { files: files } });
            }
        });
        
        // Close modal when clicking overlay
        document.getElementById('modalOverlay').addEventListener('click', closeComparisonMode);
        
        // Sample JSON structure for users
        const sampleJSON = {
            agents: [
                {
                    id: "agent_001",
                    name: "Mar√≠a Gonz√°lez",
                    age: 35,
                    gender: "F",
                    occupation: "Profesora",
                    location: "Providencia, Santiago",
                    education: "Universitaria completa",
                    political_leaning: "Centro-izquierda",
                    themes: ["educaci√≥n", "igualdad", "medio ambiente"],
                    system_prompt: "Eres Mar√≠a Gonz√°lez, una profesora de 35 a√±os que vive en Providencia. Tienes una visi√≥n progresista pero pragm√°tica de la sociedad. Te preocupa la educaci√≥n p√∫blica y la desigualdad social. Respondes de manera reflexiva y educada, usando ejemplos de tu experiencia en el aula.",
                    interview_data: [
                        {role: "user", content: "¬øCu√°l es tu nombre y a qu√© te dedicas?"},
                        {role: "assistant", content: "Mi nombre es Mar√≠a Gonz√°lez, tengo 35 a√±os y soy profesora de educaci√≥n media en un liceo p√∫blico de Santiago. Llevo 10 a√±os ejerciendo y me apasiona mi trabajo, aunque reconozco que el sistema educativo tiene muchos desaf√≠os."}
                    ],
                    metadata: {
                        interview_date: "2024-03-15",
                        interviewer: "Investigador A",
                        duration_minutes: 45
                    }
                },
                {
                    id: "agent_002",
                    name: "Carlos Mu√±oz",
                    age: 52,
                    gender: "M",
                    occupation: "Comerciante",
                    location: "La Florida, Santiago",
                    education: "Media completa",
                    political_leaning: "Centro-derecha",
                    themes: ["seguridad", "econom√≠a", "emprendimiento"],
                    system_prompt: "Eres Carlos Mu√±oz, un comerciante de 52 a√±os due√±o de un almac√©n en La Florida. Eres trabajador, pragm√°tico y te preocupa la seguridad y la econom√≠a. Hablas de manera directa y pr√°ctica, bas√°ndote en tu experiencia como emprendedor.",
                    interview_data: [
                        {role: "user", content: "¬øCu√°l es tu nombre y a qu√© te dedicas?"},
                        {role: "assistant", content: "Soy Carlos Mu√±oz, tengo 52 a√±os y soy due√±o de un almac√©n aqu√≠ en La Florida. Llevo m√°s de 20 a√±os con el negocio, he visto pasar de todo. Es duro ser comerciante hoy en d√≠a, pero aqu√≠ seguimos."}
                    ],
                    metadata: {
                        interview_date: "2024-03-16",
                        interviewer: "Investigador B",
                        duration_minutes: 38
                    }
                }
            ]
        };
        
        // Function to download sample JSON
        function downloadSampleJSON() {
            const dataStr = JSON.stringify(sampleJSON, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = 'sample_agents.json';
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }
        
        // Add keyboard shortcut for quick agent switching (Ctrl+1-9)
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key >= '1' && e.key <= '9') {
                const index = parseInt(e.key) - 1;
                if (index < loadedAgents.length) {
                    document.getElementById('agentSelector').value = loadedAgents[index].id;
                    switchAgent();
                }
            }
        });
        
        // Auto-save conversation histories to localStorage
        setInterval(() => {
            if (Object.keys(conversationHistories).length > 0) {
                localStorage.setItem('conversation_histories', JSON.stringify(conversationHistories));
            }
        }, 30000); // Save every 30 seconds
        
        // Load saved conversation histories
        const savedHistories = localStorage.getItem('conversation_histories');
        if (savedHistories) {
            try {
                conversationHistories = JSON.parse(savedHistories);
            } catch (e) {
                console.error('Error loading conversation histories:', e);
            }
        }
        
        // Export all data function
        function exportAllData() {
            const exportData = {
                agents: loadedAgents,
                conversations: conversationHistories,
                timestamp: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `multi_agent_data_${Date.now()}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }
        
        // Clear all data function
        function clearAllData() {
            if (confirm('¬øEst√°s seguro de que quieres borrar todos los datos? Esta acci√≥n no se puede deshacer.')) {
                loadedAgents = [];
                currentAgent = null;
                conversationHistories = {};
                localStorage.removeItem('loaded_agents');
                localStorage.removeItem('conversation_histories');
                updateAgentSelector();
                updateAgentCheckboxes();
                resetUI();
                showNotification('üóëÔ∏è Todos los datos han sido eliminados', 'info');
            }
        }
        
        console.log('Sistema Multi-Agente inicializado correctamente');
        console.log('Para cargar agentes, usa el bot√≥n "Cargar Agentes (JSON)" o arrastra un archivo JSON a la ventana');
    </script>
</body>
</html>